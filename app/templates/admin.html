<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - PneumoDetectØŒ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…">
    <title data-i18n="admin_dashboard_title">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - PneumoDetect</title>
    <link rel="canonical" href="{{ request.url }}">
    <meta property="og:title" content="PneumoDetect â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
    <meta property="og:description" content="Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - PneumoDetectØŒ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:image" content="{{ url_for('static', filename='assets/images/og-image.png') }}">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="PneumoDetect â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
    <meta name="twitter:description" content="Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - PneumoDetectØŒ Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "PneumoDetect - Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
        "description": "Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…",
        "url": "{{ request.url }}"
    }
    </script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- CSS Unified System -->
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    
    <style>
        /* --- Global Variables & Theme --- */
        :root {
            --primary-color: #007a7a;
            --primary-hover: #005c5c;
            --tech-accent-color: #4361ee;
            --tech-accent-hover: #3a0ca3;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --light-color: #f8fafb;
            --light-section-bg: #f1f5f9;
            --dark-color: #2d3748;
            --white-color: #ffffff;
            --gray-color: #718096;
            --border-radius: 12px;
            --box-shadow: 0 10px 25px rgba(0, 0, 0, 0.07);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            --sidebar-width: 260px;
            --sidebar-collapsed-width: 70px;
            --lang-toggle-bg: rgba(192, 223, 16, 0.2);
            --lang-toggle-active-bg: var(--tech-accent-color);
        }

        [data-theme="dark"] {
            --primary-color: #00a8a8;
            --primary-hover: #008c8c;
            --tech-accent-color: #5a7fff;
            --tech-accent-hover: #4361ee;
            --light-color: #1a202c;
            --light-section-bg: #2d3748;
            --dark-color: #f7fafc;
            --white-color: #2d3748;
            --gray-color: #cbd5e0;
            --box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            --lang-toggle-bg: rgba(0, 0, 0, 0.3);
        }

        [dir="ltr"] { font-family: 'Inter', sans-serif; }
        [dir="rtl"] { font-family: 'Tajawal', sans-serif; }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.7;
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
        }

        /* --- Accessibility & Focus --- */
        a, button, input, select, textarea, [tabindex="0"] {
            outline: 2px solid transparent;
            outline-offset: 2px;
        }
        a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible, [tabindex="0"]:focus-visible {
            outline-color: var(--tech-accent-color);
            outline-offset: 3px;
        }

        /* --- Sidebar Toggle Button --- */
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1002;
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }
        
        [dir="ltr"] .sidebar-toggle {
            right: auto;
            left: 20px;
        }
        
        .sidebar-toggle:hover {
            background-color: var(--primary-hover);
            transform: scale(1.05);
        }
        
        .sidebar-toggle i {
            font-size: 1.2rem;
            transition: var(--transition);
        }
        
        /* The collapsed class is used for the desktop view animation */
        .sidebar-toggle.collapsed i {
            transform: rotate(180deg);
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--dark-color);
            color: var(--light-color);
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            position: fixed;
            top: 0;
            bottom: 0;
            right: 0;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: var(--box-shadow);
        }
        
        [dir="ltr"] .sidebar { 
            right: auto; 
            left: 0; 
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }
        
        /* The hidden class is used for mobile view and desktop collapsed view */
        .sidebar.hidden {
            /* This animation is ONLY for mobile view to slide in/out */
            transform: translateX(100%); 
        }
        
        [dir="ltr"] .sidebar.hidden {
            transform: translateX(-100%);
        }
        
        /* This class is for mobile when sidebar is open */
        .sidebar.open {
            transform: translateX(0);
        }
        
        .sidebar-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
            transition: var(--transition);
        }
        
        .sidebar.collapsed .sidebar-header {
            align-items: flex-start;
        }
        
        .sidebar-header h2 { 
            font-size: 1.5rem; 
            margin-bottom: 5px;
            transition: var(--transition);
        }
        
        .sidebar.collapsed .sidebar-header h2 {
            font-size: 1.2rem;
        }
        
        .sidebar-header p { 
            opacity: 0.7; 
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        .sidebar.collapsed .sidebar-header p {
            display: none;
        }
        
        .sidebar-menu { 
            list-style: none; 
            margin-top: 40px; 
        }
        
        .sidebar-menu li { 
            margin-bottom: 5px; 
        }
        
        .menu-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 20px;
            color: var(--light-color);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .menu-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background-color: var(--primary-color);
            transition: var(--transition);
            z-index: -1;
        }
        
        .menu-link:hover, .menu-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white-color);
        }
        
        .menu-link:hover::before, .menu-link.active::before {
            width: 100%;
        }
        
        .menu-link i { 
            width: 20px; 
            text-align: center; 
            flex-shrink: 0;
        }
        
        .menu-link span {
            transition: var(--transition);
        }
        
        .sidebar.collapsed .menu-link span {
            opacity: 0;
            visibility: hidden;
        }
        
        .sidebar.collapsed .menu-link {
            justify-content: center;
        }
        
        .sidebar.collapsed .menu-link i {
            font-size: 1.2rem;
        }
        
        /* --- Main Content --- */
        .admin-main {
            flex-grow: 1;
            /* Default: Sidebar is open, main content pushes over */
            margin-right: var(--sidebar-width); 
            background-color: var(--light-section-bg);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }
        
        [dir="ltr"] .admin-main { 
            margin-right: 0; 
            /* Default: Sidebar is open, main content pushes over */
            margin-left: var(--sidebar-width); 
        }
        
        /* New class for when sidebar is collapsed (desktop) */
        .admin-main.collapsed {
            margin-right: var(--sidebar-collapsed-width);
        }
        
        [dir="ltr"] .admin-main.collapsed {
            margin-left: var(--sidebar-collapsed-width);
        }

        /* New class for when sidebar is fully hidden (desktop and mobile) - FIX 1 */
        .admin-main.full-width {
            margin-right: 0;
            margin-left: 0;
        }

        /* --- Header --- */
        .admin-header {
            background-color: var(--white-color);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow);
        }
        
        .admin-header h1 { 
            font-size: 1.8rem; 
            color: var(--primary-color); 
        }
        
        .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
        }
        
        /* --- Language Toggle --- */
        .lang-toggle {
            position: relative;
            display: flex;
            background-color: var(--lang-toggle-bg);
            border-radius: 50px;
            padding: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }
        
        .lang-toggle:hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .lang-toggle button {
            background: none;
            border: none;
            color: var(--dark-color);
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            z-index: 2;
            font-size: 0.9rem;
        }
        
        .lang-toggle button:hover {
            color: var(--tech-accent-color);
        }
        
        .lang-toggle button.active {
            color: white;
            /* background-color: var(--lang-toggle-active-bg); */ /* Removed: background is handled by indicator */
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
        }
        
        .indicator {
            position: absolute;
            top: 4px;
            height: calc(100% - 8px);
            width: calc(50% - 4px);
            background-color: var(--lang-toggle-active-bg);
            border-radius: 50px;
            transition: var(--transition);
            z-index: 1;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
            /* Set initial position for AR (RTL default) */
            left: 4px; 
        }
        
        /* Fix the indicator position for RTL/LTR - Use Left property only for universal control */
        [dir="rtl"] .indicator {
             /* Set initial position for AR which is the Right button in RTL */
            left: calc(50% + 4px);
        }

        [dir="ltr"] .indicator {
            /* Set initial position for AR which is the Left button in LTR */
            left: 4px;
        }

        [data-theme="dark"] .lang-toggle button {
            color: var(--white-color);
        }
        
        /* --- Theme Toggle --- */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--dark-color);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 45px;
            height: 45px;
        }
        
        .theme-toggle:hover {
            background-color: var(--light-section-bg);
            transform: rotate(20deg);
        }
        
        /* --- User Badge --- */
        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--light-section-bg);
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 500;
        }
        
        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 122, 122, 0.2);
        }
        
        .btn-logout {
            background-color: var(--error-color);
            color: white;
        }
        
        .btn-logout:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
        }

        /* --- Content Area --- */
        .content { 
            padding: 30px; 
            flex-grow: 1; 
        }
        
        .page-section { 
            display: none; 
        }
        
        .page-section.active { 
            display: block; 
        }

        /* --- Stats Grid --- */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        
        .stat-card {
            background-color: var(--white-color);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }
        
        .stat-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
        }
        
        .stat-info h3 { 
            font-size: 0.9rem; 
            color: var(--gray-color); 
            margin-bottom: 5px; 
        }
        
        .stat-info .value { 
            font-size: 2.2rem; 
            font-weight: 700; 
            color: var(--dark-color); 
        }
        
        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.2;
            color: var(--primary-color);
        }

        /* --- Forms & Tables --- */
        .form-container, .table-container {
            background-color: var(--white-color);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }
        
        .form-container h3, .table-container h3 { 
            margin-bottom: 20px; 
            font-size: 1.3rem; 
            color: var(--dark-color); 
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: var(--white-color);
            color: var(--dark-color);
        }
        
        .form-group input:focus, .form-group select:focus { 
            border-color: var(--tech-accent-color); 
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .error-text { 
            color: var(--error-color); 
            font-size: 0.85rem; 
            margin-top: 5px; 
            display: none; 
        }

        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        
        thead th { 
            background-color: var(--light-section-bg); 
            padding: 15px; 
            text-align: right; 
            font-weight: 600; 
        }
        
        [dir="ltr"] thead th { 
            text-align: left; 
        }
        
        tbody td { 
            padding: 15px; 
            border-bottom: 1px solid #f0f0f0; 
        }
        
        tbody tr:hover { 
            background-color: rgba(0, 122, 122, 0.05); 
        }
        
        .action-buttons { 
            display: flex; 
            gap: 10px; 
        }
        
        .btn-edit { 
            background-color: var(--warning-color); 
        }
        
        .btn-delete { 
            background-color: var(--error-color); 
        }
        
        .btn-edit, .btn-delete { 
            color: var(--white-color); 
            padding: 8px 12px; 
            border-radius: 6px; 
            border: none; 
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-edit:hover, .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* --- Danger Zone --- */
        .danger-zone { 
            border: 2px dashed var(--error-color); 
            padding: 20px; 
            border-radius: var(--border-radius); 
            text-align: center; 
        }
        
        .danger-zone h3 { 
            color: var(--error-color); 
            margin-bottom: 10px; 
        }
        
        .danger-zone p { 
            margin-bottom: 20px; 
            color: var(--gray-color); 
        }
        
        .btn-danger { 
            background-color: var(--error-color); 
            color: var(--white-color); 
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.2);
        }

        /* --- Modal --- */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1001; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(5px);
        }
        
        .modal-content { 
            background-color: var(--white-color); 
            margin: 10% auto; 
            padding: 30px; 
            width: 90%; 
            max-width: 500px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow);
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
        }
        
        .modal-header h3 { 
            color: var(--error-color); 
        }
        
        .close { 
            font-size: 28px; 
            font-weight: bold; 
            color: var(--gray-color); 
            cursor: pointer; 
            background: none; 
            border: none;
            transition: var(--transition);
        }
        
        .close:hover { 
            color: var(--dark-color); 
            transform: rotate(90deg);
        }
        
        .modal-footer { 
            margin-top: 20px; 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
        }

        /* --- Skeleton Loader --- */
        .skeleton { 
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); 
            background-size: 200% 100%; 
            animation: loading 1.5s infinite; 
        }
        
        @keyframes loading { 
            0% { background-position: 200% 0; } 
            100% { background-position: -200% 0; } 
        }
        
        .skeleton-row { 
            height: 20px; 
            margin-bottom: 10px; 
            border-radius: 5px; 
        }
        
        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            /* Mobile: Sidebar is hidden by default and uses transform to slide */
            .sidebar { 
                transform: translateX(100%); 
            }
            
            [dir="ltr"] .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open { 
                transform: translateX(0); 
            }
            
            /* Mobile: Main content is always full width on mobile - FIX 1 */
            .admin-main { 
                margin-right: 0; 
                margin-left: 0;
            }
            
            [dir="ltr"] .admin-main { 
                margin-left: 0; 
                margin-right: 0;
            }
            
            .sidebar-toggle {
                display: flex;
            }
            
            .stats-grid { 
                grid-template-columns: 1fr; 
            }
            
            .content { 
                padding: 20px; 
            }
            
            .table-container { 
                overflow-x: auto; 
            }
        }
        
        @media (min-width: 769px) {
            /* Desktop: Sidebar is fixed to the left/right and main content uses margin */
            .sidebar {
                transform: translateX(0) !important; /* Override mobile transform */
            }
            
            .admin-main.full-width {
                /* When collapsed state is forced to full width (like hidden on desktop) */
                margin-right: 0;
                margin-left: 0;
            }

             [dir="rtl"] .admin-main.full-width {
                margin-right: 0;
            }

            [dir="ltr"] .admin-main.full-width {
                margin-left: 0;
            }
        }
    </style>
</head>
<body role="application">
    <button class="sidebar-toggle" id="sidebar-toggle" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
        <i class="fas fa-chevron-right"></i>
    </button>

    <aside class="sidebar" id="sidebar" role="navigation" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
        <div class="sidebar-header">
            <h2 data-i18n="admin_panel_title">âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <p data-i18n="admin_panel_subtitle">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
        </div>
        <ul class="sidebar-menu">
            <li><a href="/" class="menu-link" data-section="home"><i class="fas fa-home"></i> <span data-i18n="menu_home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a></li>
            <li><a href="#dashboard" class="menu-link active" data-section="dashboard"><i class="fas fa-chart-line"></i> <span data-i18n="menu_dashboard">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span></a></li>
            <li><a href="#users" class="menu-link" data-section="users"><i class="fas fa-users"></i> <span data-i18n="menu_users">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</span></a></li>
            <li><a href="#analyses" class="menu-link" data-section="analyses"><i class="fas fa-file-medical-alt"></i> <span data-i18n="menu_analyses">Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„</span></a></li>
            <li><a href="#settings" class="menu-link" data-section="settings"><i class="fas fa-cog"></i> <span data-i18n="menu_settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></a></li>
        </ul>
    </aside>

    <main class="admin-main" id="admin-main" role="main">
        <header class="admin-header" role="banner" style="background-color: rgba(255,255,255,0.95); backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; transition: all 0.4s cubic-bezier(0.4,0,0.2,1); min-height: 80px; display: flex; align-items: center; padding: 32px 40px;">
            <div class="branding" style="display: flex; align-items: center; gap: 18px; font-size: 2.2rem; font-weight: 800; color: #007a7a; position: absolute; right: 40px; height: 100%;">
                <i class="fas fa-lungs" aria-hidden="true"></i>
                <h1>PneumoDetect</h1>
            </div>
            <h1 data-i18n="admin_welcome_title" style="margin-right: 220px;">ğŸ¥ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© PneumoDetect</h1>
            <div class="header-actions" style="display: flex; align-items: center; gap: 20px; position: absolute; left: 30px;">
                <div class="lang-toggle" role="group" aria-label="ØªØºÙŠÙŠØ± Ø§Ù„Ù„ØºØ©">
                    <button onclick="setLanguage('ar')" data-lang="ar" class="active" aria-pressed="true">AR</button>
                    <button onclick="setLanguage('en')" data-lang="en" aria-pressed="false">EN</button>
                    <div class="indicator"></div>
                </div>
                <button class="theme-toggle" id="theme-toggle" aria-label="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
                <button class="theme-toggle" id="print-btn" aria-label="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØµÙØ­Ø©">
                    <i class="fas fa-print"></i>
                </button>
                <div class="user-badge">
                    <i class="fas fa-shield-alt"></i> 
                    <span id="current-user-info">{{ username }}</span>
                </div>
                <button class="btn btn-logout" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> 
                    <span data-i18n="logout_btn">Ø®Ø±ÙˆØ¬</span>
                </button>
            </div>
        </header>

        <div class="content">
            <section id="home-section" class="page-section">
                <h2 data-i18n="home_title">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
                <div class="form-container">
                    <h3 data-i18n="welcome_message">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… PneumoDetect</h3>
                    <p data-i18n="home_description">Ù†Ø¸Ø§Ù… Ù…ØªÙ‚Ø¯Ù… Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø±Ø¦Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù† Ø®Ù„Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ø·Ø¨ÙŠØ© ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù….</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-info">
                                <h3 data-i18n="quick_start">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</h3>
                                <div class="value"><i class="fas fa-arrow-circle-right"></i></div>
                            </div>
                            <div class="stat-icon"><i class="fas fa-rocket"></i></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-info">
                                <h3 data-i18n="quick_analyze">ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h3>
                                <div class="value"><i class="fas fa-plus-circle"></i></div>
                            </div>
                            <div class="stat-icon"><i class="fas fa-x-ray"></i></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-info">
                                <h3 data-i18n="quick_reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
                                <div class="value"><i class="fas fa-chart-bar"></i></div>
                            </div>
                            <div class="stat-icon"><i class="fas fa-file-alt"></i></div>
                        </div>
                    </div>
                    
                    <div class="form-container" style="margin-top: 30px;">
                        <h3 data-i18n="recent_activities">Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©</h3>
                        <ul style="list-style-type: none; padding: 0;">
                            <li style="padding: 10px 0; border-bottom: 1px solid #eee;">
                                <i class="fas fa-user-plus" style="color: var(--success-color); margin-left: 10px;"></i>
                                <span data-i18n="activity_new_user">ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</span>
                                <span style="float: left; color: var(--gray-color);">Ù…Ù†Ø° 5 Ø¯Ù‚Ø§Ø¦Ù‚</span>
                            </li>
                            <li style="padding: 10px 0; border-bottom: 1px solid #eee;">
                                <i class="fas fa-file-medical-alt" style="color: var(--tech-accent-color); margin-left: 10px;"></i>
                                <span data-i18n="activity_new_analysis">ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</span>
                                <span style="float: left; color: var(--gray-color);">Ù…Ù†Ø° 15 Ø¯Ù‚ÙŠÙ‚Ø©</span>
                            </li>
                            <li style="padding: 10px 0; border-bottom: 1px solid #eee;">
                                <i class="fas fa-cog" style="color: var(--warning-color); margin-left: 10px;"></i>
                                <span data-i18n="activity_settings_update">ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</span>
                                <span style="float: left; color: var(--gray-color);">Ù…Ù†Ø° Ø³Ø§Ø¹Ø©</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="dashboard-section" class="page-section active">
                <h2 data-i18n="admin_dashboard_title">ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3 data-i18n="stat_total_users">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                            <div class="value" id="total-users">0</div>
                        </div>
                        <div class="stat-icon"><i class="fas fa-users"></i></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3 data-i18n="stat_total_analyses">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„</h3>
                            <div class="value" id="total-analyses">0</div>
                        </div>
                        <div class="stat-icon"><i class="fas fa-file-medical-alt"></i></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3 data-i18n="stat_pneumonia_cases">Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø§Ù„ØªÙ‡Ø§Ø¨</h3>
                            <div class="value" id="pneumonia-cases">0</div>
                        </div>
                        <div class="stat-icon"><i class="fas fa-virus"></i></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-info">
                            <h3 data-i18n="stat_accuracy">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¯Ù‚Ø©</h3>
                            <div class="value">98%</div>
                        </div>
                        <div class="stat-icon"><i class="fas fa-chart-pie"></i></div>
                    </div>
                </div>
            </section>

            <section id="users-section" class="page-section">
                <div class="form-container">
                    <h3 data-i18n="add_user_title">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
                    <form id="add-user-form" role="form" aria-label="Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…">
                        <div class="form-group">
                            <label for="new-username" data-i18n="username_label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                            <input type="text" id="new-username" name="username" required>
                            <span id="new-username-error" class="error-text"></span>
                        </div>
                        <div class="form-group">
                            <label for="new-email" data-i18n="email_label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="email" id="new-email" name="email" required>
                            <span id="new-email-error" class="error-text"></span>
                        </div>
                        <div class="form-group">
                            <label for="new-role" data-i18n="role_label">Ø§Ù„Ù†ÙˆØ¹</label>
                            <select id="new-role" name="role" required>
                                <option value="patient" data-i18n="role_patient">Ù…Ø±ÙŠØ¶</option>
                                <option value="doctor" data-i18n="role_doctor">Ø·Ø¨ÙŠØ¨</option>
                                <option value="admin" data-i18n="role_admin">Ù…Ø³Ø¤ÙˆÙ„</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" aria-label="Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯">
                            <i class="fas fa-user-plus"></i> 
                            <span data-i18n="add_user_btn">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</span>
                        </button>
                    </form>
                </div>

                <div class="table-container">
                    <h3 data-i18n="users_list_title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                    <table role="table" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†">
                        <thead>
                            <tr>
                                <th data-i18n="table_username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                                <th data-i18n="table_email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                                <th data-i18n="table_role">Ø§Ù„Ù†ÙˆØ¹</th>
                                <th data-i18n="table_status">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th data-i18n="table_actions">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr><td colspan="5"><div class="skeleton skeleton-row"></div></td></tr>
                            <tr><td colspan="5"><div class="skeleton skeleton-row"></div></td></tr>
                            <tr><td colspan="5"><div class="skeleton skeleton-row"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="analyses-section" class="page-section">
                <div class="table-container">
                    <h3 data-i18n="analyses_management_title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„</h3>
                    <table role="table" aria-label="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„">
                        <thead>
                            <tr>
                                <th data-i18n="table_id">Ø±Ù‚Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„</th>
                                <th data-i18n="table_patient">Ø§Ù„Ù…Ø±ÙŠØ¶</th>
                                <th data-i18n="table_doctor">Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
                                <th data-i18n="table_date">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                <th data-i18n="table_result">Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                <th data-i18n="table_status">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                        </thead>
                        <tbody id="analyses-table-body">
                             <tr><td colspan="6"><div class="skeleton skeleton-row"></div></td></tr>
                            <tr><td colspan="6"><div class="skeleton skeleton-row"></div></td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="settings-section" class="page-section">
                <div class="form-container">
                    <h3 data-i18n="system_settings_title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                    <form id="settings-form" role="form" aria-label="Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…">
                        <div class="form-group">
                            <label for="max-file-size" data-i18n="setting_max_file_size">Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (MB)</label>
                            <input type="number" id="max-file-size" name="max_file_size" value="50" min="1" max="500">
                        </div>
                        <div class="form-group">
                            <label for="daily-limit" data-i18n="setting_daily_limit">Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙŠÙˆÙ…ÙŠØ§Ù‹</label>
                            <input type="number" id="daily-limit" name="daily_limit" value="100" min="1">
                        </div>
                        <div class="form-group">
                            <label for="min-confidence" data-i18n="setting_min_confidence">Ù†Ø³Ø¨Ø© Ø§Ù„Ø«Ù‚Ø© Ø§Ù„Ø¯Ù†ÙŠØ§ (%)</label>
                            <input type="number" id="min-confidence" name="min_confidence" value="70" min="0" max="100">
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 
                            <span data-i18n="save_settings_btn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                        </button>
                    </form>
                </div>

                <div class="form-container danger-zone">
                    <h3 data-i18n="danger_zone_title">ğŸ›‘ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h3>
                    <p data-i18n="danger_zone_desc">Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
                    <button type="button" class="btn btn-danger" onclick="confirmDangerAction('clearAllData')">
                        <i class="fas fa-trash-alt"></i> 
                        <span data-i18n="clear_all_data_btn">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                    </button>
                </div>
            </section>
        </div>
    </main>

    <div id="confirm-modal" class="modal" role="dialog" aria-labelledby="modal-title" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" data-i18n="confirm_action_title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p id="modal-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">
                    <span data-i18n="cancel_btn">Ø¥Ù„ØºØ§Ø¡</span>
                </button>
                <button type="button" class="btn btn-danger" id="confirm-btn">
                    <span data-i18n="confirm_btn">ØªØ£ÙƒÙŠØ¯</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Complete Translations
        const translations = {
            ar: {
                admin_dashboard_title: "Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", admin_panel_title: "âš™ï¸ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", admin_panel_subtitle: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", admin_welcome_title: "ğŸ¥ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© PneumoDetect",
                menu_home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", menu_dashboard: "Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", menu_users: "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†", menu_analyses: "Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„", menu_settings: "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
                home_title: "ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", welcome_message: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… PneumoDetect", home_description: "Ù†Ø¸Ø§Ù… Ù…ØªÙ‚Ø¯Ù… Ù„Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„ØªÙ‡Ø§Ø¨ Ø§Ù„Ø±Ø¦Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ù† Ø®Ù„Ø§Ù„ Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„Ø·Ø¨ÙŠØ© ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù….",
                quick_start: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†", quick_analyze: "ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯", quick_reports: "Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±", recent_activities: "Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©",
                activity_new_user: "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯", activity_new_analysis: "ØªÙ… Ø¥Ø¬Ø±Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯", activity_settings_update: "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…",
                stat_total_users: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", stat_total_analyses: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„", stat_pneumonia_cases: "Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø§Ù„ØªÙ‡Ø§Ø¨", stat_accuracy: "Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¯Ù‚Ø©",
                add_user_title: "Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯", username_label: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", email_label: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", role_label: "Ø§Ù„Ù†ÙˆØ¹",
                role_patient: "Ù…Ø±ÙŠØ¶", role_doctor: "Ø·Ø¨ÙŠØ¨", role_admin: "Ù…Ø³Ø¤ÙˆÙ„", add_user_btn: "Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
                users_list_title: "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", table_username: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", table_email: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", table_role: "Ø§Ù„Ù†ÙˆØ¹", table_status: "Ø§Ù„Ø­Ø§Ù„Ø©", table_actions: "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª",
                analyses_management_title: "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„", table_id: "Ø±Ù‚Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„", table_patient: "Ø§Ù„Ù…Ø±ÙŠØ¶", table_doctor: "Ø§Ù„Ø·Ø¨ÙŠØ¨", table_date: "Ø§Ù„ØªØ§Ø±ÙŠØ®", table_result: "Ø§Ù„Ù†ØªÙŠØ¬Ø©",
                system_settings_title: "Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…", setting_max_file_size: "Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (MB)", setting_daily_limit: "Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ ÙŠÙˆÙ…ÙŠØ§Ù‹", setting_min_confidence: "Ù†Ø³Ø¨Ø© Ø§Ù„Ø«Ù‚Ø© Ø§Ù„Ø¯Ù†ÙŠØ§ (%)", save_settings_btn: "Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª",
                danger_zone_title: "ğŸ›‘ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±", danger_zone_desc: "Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡Ø§. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©.", clear_all_data_btn: "Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
                confirm_action_title: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡", cancel_btn: "Ø¥Ù„ØºØ§Ø¡", confirm_btn: "ØªØ£ÙƒÙŠØ¯", confirm_logout: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ",
                error_username_length: "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 3 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.", error_email_invalid: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­.", error_role_required: "ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….",
                success_user_added: "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.", error_adding_user: "ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….",
                success_settings_saved: "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.", error_saving_settings: "ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.",
                success_data_cleared: "ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­.", error_clearing_data: "ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.",
                error_network: "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….", logout_btn: "Ø®Ø±ÙˆØ¬"
            },
            en: {
                admin_dashboard_title: "Admin Dashboard", admin_panel_title: "âš™ï¸ Admin", admin_panel_subtitle: "Control Panel", admin_welcome_title: "ğŸ¥ PneumoDetect Admin Dashboard",
                menu_home: "Home", menu_dashboard: "Dashboard", menu_users: "Users", menu_analyses: "Analyses", menu_settings: "Settings",
                home_title: "ğŸ  Home Page", welcome_message: "Welcome to PneumoDetect System", home_description: "An advanced system for pneumonia detection using artificial intelligence techniques. Through this interface, you can manage users, medical analyses, and monitor system performance.",
                quick_start: "Get Started", quick_analyze: "New Analysis", quick_reports: "Reports", recent_activities: "Recent Activities",
                activity_new_user: "New user added", activity_new_analysis: "New analysis performed", activity_settings_update: "System settings updated",
                stat_total_users: "Total Users", stat_total_analyses: "Total Analyses", stat_pneumonia_cases: "Pneumonia Cases", stat_accuracy: "Accuracy Rate",
                add_user_title: "Add New User", username_label: "Username", email_label: "Email", role_label: "Role",
                role_patient: "Patient", role_doctor: "Doctor", role_admin: "Admin", add_user_btn: "Add User",
                users_list_title: "Users List", table_username: "Username", table_email: "Email", table_role: "Role", table_status: "Status", table_actions: "Actions",
                analyses_management_title: "Analyses Management", table_id: "Analysis ID", table_patient: "Patient", table_doctor: "Doctor", table_date: "Date", table_result: "Result",
                system_settings_title: "System Settings", setting_max_file_size: "Max File Size (MB)", setting_daily_limit: "Daily Analysis Limit", setting_min_confidence: "Min Confidence (%)", save_settings_btn: "Save Settings",
                danger_zone_title: "ğŸ›‘ Danger Zone", danger_zone_desc: "These actions are irreversible. Please be certain before proceeding.", clear_all_data_btn: "Clear All Data",
                confirm_action_title: "Confirm Action", cancel_btn: "Cancel", confirm_btn: "Confirm", confirm_logout: "Are you sure you want to logout?",
                error_username_length: "Username must be at least 3 characters.", error_email_invalid: "Invalid email address.", error_role_required: "User role is required.",
                success_user_added: "User added successfully.", error_adding_user: "Failed to add user.",
                success_settings_saved: "Settings saved successfully.", error_saving_settings: "Failed to save settings.",
                success_data_cleared: "All data cleared successfully.", error_clearing_data: "Failed to clear data.",
                error_network: "Network error.", logout_btn: "Logout"
            }
        };

        const appState = { 
            currentLang: 'ar',
            isDarkMode: false,
            currentSection: 'dashboard',
            elementToFocusOnModalClose: null,
            sidebarCollapsed: false,
            sidebarHidden: false
        };
        
        // Caching DOM elements for efficiency
        const DOM = {};
        
        document.addEventListener('DOMContentLoaded', () => {
            DOM.sidebar = document.getElementById('sidebar');
            DOM.adminMain = document.getElementById('admin-main');
            DOM.toggleBtn = document.getElementById('sidebar-toggle');
            DOM.themeToggle = document.getElementById('theme-toggle');
            DOM.themeIcon = document.getElementById('theme-icon');
            DOM.langToggle = document.querySelector('.lang-toggle');
            DOM.langIndicator = document.querySelector('.indicator');

            const savedLang = localStorage.getItem('pneumoDetectLang') || 'ar';
            const savedTheme = localStorage.getItem('pneumoDetectTheme') || 'light';
            const savedSidebarCollapsed = localStorage.getItem('pneumoDetectSidebarCollapsed') === 'true';
            
            // Set initial state based on saved preferences
            setLanguage(savedLang);
            setTheme(savedTheme);
            // We use savedSidebarCollapsed to set the initial desktop state.
            // Mobile state is determined by screen width on load.
            setSidebarState(savedSidebarCollapsed);
            setupEventListeners();
            loadDashboardData();
        });

        function setupEventListeners() {
            // Sidebar navigation
            document.querySelectorAll('.menu-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showSection(link.dataset.section);
                    // Close sidebar on mobile after selection
                    if (window.innerWidth <= 768) {
                        setSidebarState(false, true); // Set to hidden on mobile
                    }
                });
            });

            // Sidebar toggle
            DOM.toggleBtn?.addEventListener('click', toggleSidebar);

            // Theme toggle
            DOM.themeToggle?.addEventListener('click', toggleTheme);

            // Forms
            document.getElementById('add-user-form')?.addEventListener('submit', handleAddUser);
            document.getElementById('settings-form')?.addEventListener('submit', handleSaveSettings);
        }

        function toggleSidebar() {
            if (window.innerWidth <= 768) {
                // On mobile, toggle between hidden and visible (using 'open' class)
                appState.sidebarHidden = !DOM.sidebar.classList.contains('open');
                setSidebarState(false, appState.sidebarHidden); 
            } else {
                // On desktop, toggle between collapsed and expanded
                appState.sidebarCollapsed = !appState.sidebarCollapsed;
                setSidebarState(appState.sidebarCollapsed, false);
            }
            // Update local storage for desktop collapsed state
            localStorage.setItem('pneumoDetectSidebarCollapsed', appState.sidebarCollapsed);
        }

        function setSidebarState(isCollapsed, isHidden=false) {
            appState.sidebarCollapsed = isCollapsed;

            // --- Desktop Logic (min-width: 769px) ---
            if (window.innerWidth > 768) {
                DOM.sidebar.classList.remove('open');
                DOM.adminMain.classList.remove('full-width');
                
                if (isCollapsed) {
                    DOM.sidebar.classList.add('collapsed');
                    DOM.adminMain.classList.add('collapsed');
                    DOM.toggleBtn.classList.add('collapsed');
                    DOM.toggleBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                } else {
                    DOM.sidebar.classList.remove('collapsed');
                    DOM.adminMain.classList.remove('collapsed');
                    DOM.toggleBtn.classList.remove('collapsed');
                    DOM.toggleBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                }
            } 
            // --- Mobile Logic (max-width: 768px) ---
            else {
                DOM.sidebar.classList.remove('collapsed');
                DOM.adminMain.classList.remove('collapsed');
                DOM.adminMain.classList.remove('full-width'); // Mobile is full width by default CSS
                
                if (isHidden) {
                    DOM.sidebar.classList.remove('open');
                    DOM.toggleBtn.innerHTML = '<i class="fas fa-bars"></i>';
                } else {
                    DOM.sidebar.classList.add('open');
                    DOM.toggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                }
            }
        }

        function showSection(sectionName) {
            appState.currentSection = sectionName;
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
            
            document.getElementById(`${sectionName}-section`).classList.add('active');
            document.querySelector(`.menu-link[data-section="${sectionName}"]`).classList.add('active');

            if (sectionName === 'users') loadUsers();
            if (sectionName === 'analyses') loadAnalyses();
        }

        // --- CSRF Token Helper ---
        function getCsrfToken() {
            const name = 'XSRF-TOKEN=';
            const decodedCookie = decodeURIComponent(document.cookie);
            const cookieArray = decodedCookie.split(';');
            for (let i = 0; i < cookieArray.length; i++) {
                let cookie = cookieArray[i].trim();
                if (cookie.indexOf(name) === 0) {
                    return cookie.substring(name.length);
                }
            }
            return '';
        }

        // --- Data Loading Functions (with Backend Integration Simulation) ---
        async function loadDashboardData() {
            try {
                // Real API call to /api/admin/stats/system
                const response = await fetch('/api/admin/stats/system', {
                    method: 'GET',
                    headers: {
                        'X-CSRF-Token': getCsrfToken()
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                const result = await response.json();
                
                const data = result.data || { total_users: 0, total_analyses: 0, pneumonia_cases: 0 };

                document.getElementById('total-users').textContent = data.total_users || 0;
                document.getElementById('total-analyses').textContent = data.total_analyses || 0;
                document.getElementById('pneumonia-cases').textContent = data.pneumonia_cases || 0;
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showNotification(t('error_network'), 'error');
            }
        }
        
        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = `<tr><td colspan="5"><div class="skeleton skeleton-row"></div></td></tr>`.repeat(3);
            
            try {
                // Real API call to /api/admin/stats/users
                const response = await fetch('/api/admin/stats/users', {
                    method: 'GET',
                    headers: {
                        'X-CSRF-Token': getCsrfToken()
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                const result = await response.json();
                
                const users = result.data?.items || [];

                if (users.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td><span class="badge badge-${user.role}">${getRoleName(user.role)}</span></td>
                        <td><span class="badge ${user.is_active ? 'badge-active' : 'badge-inactive'}">${user.is_active ? 'Ù†Ø´Ø·' : 'Ù…Ø¹Ø·Ù„'}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-edit" onclick="editUser('${user.id}')" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user.username}"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-delete" onclick="deleteUser('${user.id}')" aria-label="Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user.username}"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showNotification(t('error_network'), 'error');
                tbody.innerHTML = `<tr><td colspan="5" class="error-message">${t('error_network')}</td></tr>`;
            }
        }
        
        async function loadAnalyses() {
            const tbody = document.getElementById('analyses-table-body');
            tbody.innerHTML = `<tr><td colspan="6"><div class="skeleton skeleton-row"></div></td></tr>`.repeat(3);
            
            try {
                // Real API call to /api/admin/analyses
                const response = await fetch('/api/admin/analyses', {
                    method: 'GET',
                    headers: {
                        'X-CSRF-Token': getCsrfToken()
                    },
                    credentials: 'include'
                });
                
                if (!response.ok) throw new Error('Network response was not ok');
                const result = await response.json();
                
                const analyses = result.data?.items || [];

                if (analyses.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
                    return;
                }

                tbody.innerHTML = analyses.map(analysis => `
                    <tr>
                        <td>${analysis.id}</td>
                        <td>${analysis.patient_name}</td>
                        <td>${analysis.doctor_name}</td>
                        <td>${new Date(analysis.date).toLocaleDateString()}</td>
                        <td><span class="badge ${analysis.result === 'pneumonia' ? 'badge-danger' : 'badge-success'}">${analysis.result}</span></td>
                        <td><span class="badge ${analysis.status === 'completed' ? 'badge-success' : 'badge-warning'}">${analysis.status}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                showNotification(t('error_network'), 'error');
                tbody.innerHTML = `<tr><td colspan="6" class="error-message">${t('error_network')}</td></tr>`;
            }
        }
        
        // --- Action Handlers (with Enhanced Validation) ---
        async function handleAddUser(e) {
            e.preventDefault();
            clearErrors();
            
            const username = document.getElementById('new-username').value.trim();
            const email = document.getElementById('new-email').value.trim();
            const role = document.getElementById('new-role').value;

            let isValid = true;
            if (username.length < 3) {
                showError('new-username-error', t('error_username_length'));
                isValid = false;
            }
            if (!validateEmail(email)) {
                showError('new-email-error', t('error_email_invalid'));
                isValid = false;
            }
            if (!role) {
                // No specific error element for role select, but can add one if needed
                isValid = false;
            }

            if (!isValid) return;

            const formData = { username, email, role };
            
            try {
                // Real API call to /api/admin/users
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    },
                    credentials: 'include',
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (result.success || response.ok) {
                    showNotification(t('success_user_added'), 'success');
                    e.target.reset();
                    loadUsers();
                } else {
                    throw new Error(result.message || t('error_adding_user'));
                }
            } catch (error) {
                showNotification(error.message || t('error_network'), 'error');
            }
        }

        async function handleSaveSettings(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            try {
                // Real API call to /api/admin/settings
                const response = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': getCsrfToken()
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (result.success || response.ok) {
                    showNotification(t('success_settings_saved'), 'success');
                } else {
                    throw new Error(result.message || t('error_saving_settings'));
                }
            } catch (error) {
                showNotification(error.message || t('error_network'), 'error');
            }
        }

        function editUser(userId) { showNotification(`ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${userId} (Ù…Ø­Ø§ÙƒØ§Ø©)`, 'info'); }
        async function deleteUser(userId) {
            openModal(t('confirm_delete_user'), async () => {
                try {
                    const response = await fetch(`/api/admin/users/${userId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': getCsrfToken()
                        },
                        credentials: 'include',
                        body: JSON.stringify({ is_active: false })
                    });

                    let payload = {};
                    try { payload = await response.json(); } catch (e) {}

                    if (!response.ok) throw new Error(payload.message || t('error_network'));

                    showNotification(t('success_user_deleted') || 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    loadUsers();
                } catch (error) {
                    console.error('Error deleting user:', error);
                    showNotification(error.message || t('error_network'), 'error');
                }
            });
        }
        
        function confirmDangerAction(action) {
             let message = '';
             let onConfirm = () => {};

             if (action === 'clearAllData') {
                message = t('danger_zone_desc');
                onConfirm = async () => {
                    try {
                        // Real API call to /api/admin/clear-data (requires explicit confirmation)
                        const response = await fetch('/api/admin/clear-data', { 
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': getCsrfToken()
                            },
                            credentials: 'include',
                            body: JSON.stringify({ confirm_clearance: 'CLEAR_ALL_DATA' })
                        });
                        const result = await response.json();

                        if (result.success || response.ok) {
                             showNotification(t('success_data_cleared'), 'success');
                             loadDashboardData();
                             loadUsers();
                        } else {
                            throw new Error(result.message || t('error_clearing_data'));
                        }
                    } catch (error) {
                        showNotification(error.message || t('error_network'), 'error');
                    }
                };
             }
             openModal(message, onConfirm);
        }

        // --- Modal Functions (with Focus Trap) ---
        function openModal(message, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            document.getElementById('modal-message').textContent = message;
            document.getElementById('confirm-btn').onclick = () => { onConfirm(); closeModal(); };
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
            
            // Focus Trap
            appState.elementToFocusOnModalClose = document.activeElement;
            const focusableElements = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstFocusableEl = focusableElements[0];
            const lastFocusableEl = focusableElements[focusableElements.length - 1];
            
            // Set up a global function for the event listener to be able to remove it later
            modal._trapFocusHandler = function(e) {
                if (e.key === 'Tab') {
                    if (e.shiftKey) { // Shift + Tab
                        if (document.activeElement === firstFocusableEl) {
                            e.preventDefault();
                            lastFocusableEl.focus();
                        }
                    } else { // Tab
                        if (document.activeElement === lastFocusableEl) {
                            e.preventDefault();
                            firstFocusableEl.focus();
                        }
                    }
                }
                if (e.key === 'Escape') {
                    closeModal();
                }
            };

            modal.addEventListener('keydown', modal._trapFocusHandler);
            firstFocusableEl.focus();
        }

        function closeModal() {
            const modal = document.getElementById('confirm-modal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            // Remove the specific focus trap listener
            if (modal._trapFocusHandler) {
                 modal.removeEventListener('keydown', modal._trapFocusHandler);
                 modal._trapFocusHandler = null;
            }
            if (appState.elementToFocusOnModalClose) {
                appState.elementToFocusOnModalClose.focus();
            }
        }
        
        // --- Helper Functions ---
        function getRoleName(role) { 
             const roles = { patient: t('role_patient'), doctor: t('role_doctor'), admin: t('role_admin') }; 
             return roles[role] || role; 
        }
        
        function validateEmail(email) { 
            const re = /^\S+@\S+\.\S+$/; 
            return re.test(email); 
        }
        
        function showError(elementId, message) { 
            const el = document.getElementById(elementId);
            if(el) {
                el.textContent = message; 
                el.style.display = 'block'; 
            }
        }
        
        function clearErrors() { 
            document.querySelectorAll('.error-text').forEach(el => { 
                el.style.display = 'none'; 
                el.textContent = ''; 
            }); 
        }
        
        // --- Theme & Language (FIX 2 applied here) ---
        function setLanguage(lang) {
            appState.currentLang = lang;
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Update language toggle buttons
            const langButtons = document.querySelectorAll('.lang-toggle button');
            let selectedButton = null;
            
            langButtons.forEach(btn => {
                const isActive = btn.getAttribute('data-lang') === lang;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                if (isActive) {
                    selectedButton = btn;
                }
            });
            
            // Update indicator position - FIX 2: Use selected button's left offset
            const indicator = DOM.langIndicator;
            if (indicator && selectedButton) {
                const buttonRect = selectedButton.getBoundingClientRect();
                const toggleRect = DOM.langToggle.getBoundingClientRect();
                
                // Calculate position relative to the toggle container
                const leftPosition = buttonRect.left - toggleRect.left;
                
                // Adjust position based on padding (4px)
                indicator.style.left = `${leftPosition}px`;
                
                // Note: Indicator width must be button width - (2 * padding)
                // The CSS already handles the width: calc(50% - 4px) assuming two buttons.
                
                // Force a quick reflow to ensure smooth transition
                void indicator.offsetWidth; 
            }
            
            localStorage.setItem('pneumoDetectLang', lang);
        }

        function setTheme(theme) {
            appState.isDarkMode = theme === 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            
            // Update theme toggle icon
            if (DOM.themeIcon) {
                DOM.themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
            
            localStorage.setItem('pneumoDetectTheme', theme);
        }

        function toggleTheme() {
            const newTheme = appState.isDarkMode ? 'light' : 'dark';
            setTheme(newTheme);
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.textContent = message;
            
            // Style the notification
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.padding = '12px 24px';
            notification.style.borderRadius = 'var(--border-radius)';
            notification.style.color = 'white';
            notification.style.zIndex = '2000';
            notification.style.boxShadow = 'var(--box-shadow)';
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s ease';
            
            // Set background color based on type
            if (type === 'success') {
                notification.style.backgroundColor = 'var(--success-color)';
            } else if (type === 'error') {
                notification.style.backgroundColor = 'var(--error-color)';
            } else {
                notification.style.backgroundColor = 'var(--tech-accent-color)';
            }
            
            // Add to DOM
            document.body.appendChild(notification);
            
            // Fade in
            setTimeout(() => {
                notification.style.opacity = '1';
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function handleLogout() {
            openModal(t('confirm_logout'), () => {
                // In a real app, this would clear the session and redirect to login
                localStorage.removeItem('pneumoDetectToken');
                window.location.href = '/login';
            });
        }

        function t(key) { 
            return translations[appState.currentLang][key] || key; 
        }
        
        // Add required translations for simulated data/actions
        translations.ar.status_active = "Ù†Ø´Ø·";
        translations.ar.status_inactive = "ØºÙŠØ± Ù†Ø´Ø·";
        translations.ar.confirm_delete_user = "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.";
        translations.ar.success_user_deleted = "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­";
        translations.ar.error_loading_data = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";

        translations.en.status_active = "Active";
        translations.en.status_inactive = "Inactive";
        translations.en.confirm_delete_user = "Are you sure you want to delete this user? This action cannot be undone.";
        translations.en.success_user_deleted = "User deleted successfully";
        translations.en.error_loading_data = "Failed to load data";
    </script>
    <!-- Core JavaScript Module -->
    <script src="{{ url_for('static', filename='core.js') }}"></script>
    <script>
        // Initialize PneumoApp on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (window.PneumoApp) {
                PneumoApp.init();
                PneumoApp.Theme.init();
            }
        });
    </script>
</body>
</html>